<!DOCTYPE HTML>
<html lang="pl">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Garden of Life</title>
	<link rel="stylesheet" type="text/css" href="style.css">

	<script src="https://canvasjs.com/assets/script/jquery-1.11.1.min.js"></script>
	<script src="canvasjs.min.js"></script>
	<script>

	window.onload = function ()
	{
		var i_global = -1;
		var j_global = -1;
		var k_global = -1;

		var lastRowLight = "1";
		var lastRowMoisture = "2";
		var lastRowTemp = "3";

		const MAX_CHART_LENGTH = 10000;

		var dataPointsLight = [];
		var dataPointsLightError = [];
		var dataPointsLightValues = [];
		var dataPointsLightValuesError = [];
		var dataPointsLightValuesDate = [];

		var dataPointsMoisture = [];
		var dataPointsMoistureError = [];
		var dataPointsMoistureValues = [];
		var dataPointsMoistureValuesError = [];
		var dataPointsMoistureValuesDate = [];

		var dataPointsTemp = [];
		var dataPointsTempError = [];
		var dataPointsTempValues = [];
		var dataPointsTempValuesError = [];
		var dataPointsTempValuesDate = [];

		var dataPointsHumi = [];
		var dataPointsHumiError = [];
		var dataPointsHumiValues = [];
		var dataPointsHumiValuesError = [];
		var dataPointsHumiValuesDate = [];

		// var lightSensorFile = "home/ml/pi_data/data/LightSensor.dat";
		// var moistureSensorFile = "home/ml/pi_data/data/MoistureSensor.dat";
		// var temperatureHumiditySensorFile = "home/ml/pi_data/data/TemperatureHumiditySensor.dat";
		var lightSensorFile = "LightSensor.dat";
		var moistureSensorFile = "MoistureSensor.dat";
		var temperatureSensorFile = "TemperatureSensor.dat";
		var humiditySensorFile = "HumiditySensor.dat";

		var lightChart = new CanvasJS.Chart("lightChartContainer", {
			backgroundColor: "#e7f549",
			axisY: {
				maximum: 1200
			},
			title: {
				text: "Światło"
			},
			axisX: {
				title: "Czas"
			},
			axisY:{
				includeZero: false,
				maximum: 1200
			}, 
			toolTip: {
				shared: true
			},
			legend: {
				cursor:"pointer",
				verticalAlign: "top",
				fontSize: 22,
				fontColor: "dimGrey"
				//itemclick : toggleDataSeries
			},
			data: [
				{ 
					type: "spline",
					xValueType: "dateTime",
					markerColor: "#05a5f5",
					showInLegend: true,
					name: "Natężenie światła",
					dataPoints: dataPointsLight
				},
				{				
					type: "spline",
					xValueType: "dateTime",
					showInLegend: true,
					markerColor: "red",
					name: "Błąd",
					dataPoints: dataPointsLightError
				}]
		});

		var moistureSensorChart = new CanvasJS.Chart("moistureSensorChartContainer", {
			backgroundColor: "#ffc517",
			title: {
				text: "Gleba"
			},
			axisX: {
				title: "Czas"
			},
			axisY:{
				includeZero: false,
				maximum: 1000
			}, 
			toolTip: {
				shared: true
			},
			legend: {
				cursor:"pointer",
				verticalAlign: "top",
				fontSize: 22,
				fontColor: "dimGrey"
			},
			data: [
				{ 
					type: "spline",
					xValueType: "dateTime",
					markerColor: "#05a5f5",
					showInLegend: true,
					name: "Wilgotność",
					dataPoints: dataPointsMoisture
				},
				{				
					type: "spline",
					xValueType: "dateTime",
					markerColor: "red",
					showInLegend: true,
					name: "Błąd",
					dataPoints: dataPointsMoistureError
				}]
		});

		var temperatureSensorChart = new CanvasJS.Chart("temperatureSensorChartContainer", {
			backgroundColor: "#ffa570",
			title: {
				text: "Temperatura"
			},
			axisX: {
				title: "Czas"
			},
			axisY:{
				includeZero: false,
				maximum: 50
			}, 
			toolTip: {
				shared: true
			},
			legend: {
				cursor:"pointer",
				verticalAlign: "top",
				fontSize: 22,
				fontColor: "dimGrey"
			},
			data: [
				{ 
					type: "spline",
					xValueType: "dateTime",
					markerColor: "#05a5f5",
					showInLegend: true,
					name: "Wartości",
					dataPoints: dataPointsTemp
				},
				{				
					type: "spline",
					xValueType: "dateTime",
					showInLegend: true,
					markerColor: "red",
					name: "Błąd",
					dataPoints: dataPointsTempError
				}]
		});

		var humiditySensorChart = new CanvasJS.Chart("humiditySensorChartContainer", {
			backgroundColor: "#ffa570",
			title: {
				text: "Wilgotność"
			},
			axisX: {
				title: "Czas"
			},
			axisY:{
				includeZero: false,
				maximum: 100
			},
			toolTip: {
				shared: true
			},
			legend: {
				cursor:"pointer",
				verticalAlign: "top",
				fontSize: 22,
				fontColor: "dimGrey"
			},
			data: [
				{
					type: "spline",
					xValueType: "dateTime",
					markerColor: "#05a5f5",
					showInLegend: true,
					name: "Wartości",
					dataPoints: dataPointsHumi
				},
				{
					type: "spline",
					xValueType: "dateTime",
					showInLegend: true,
					markerColor: "red",
					name: "Błąd",
					dataPoints: dataPointsHumiError
				}]
		});

		lightChart.render();
		moistureSensorChart.render();
		temperatureSensorChart.render();
		humiditySensorChart.render();

	    var isRowPushed = false;

		var parseLightFile = function()
		{
		    // jQuery.get('trash.txt', function(data)
		    jQuery.get(lightSensorFile, function(data)
		    {
			    var lines = data.split("\n");
			    var len = lines.length;
    			var row = lines[len - 2].split(" ");

    			if(row[1].localeCompare(lastRowLight) != 0)
    			{
	        		dataPointsLightValuesDate.push(row[1]);
	        		dataPointsLightValues.push(row[2]);
	        		dataPointsLightValuesError.push(Math.abs(row[2] - row[3]));

	        		i_global++;
        			lastRowLight = row[1];

        			isRowPushed = true;
	        	}
	        	else
	        	{
	        		isRowPushed = false;
	        	}
			});
		};

		var parseMoistureFile = function()
		{
		    // jQuery.get('trash1.txt', function(data)
			jQuery.get(moistureSensorFile, function(data)
		    {
			    var lines = data.split("\n");
			    var len = lines.length;
    			var row = lines[len - 2].split(" ");

				if(row[1].localeCompare(lastRowMoisture) != 0)
    			{
	        		dataPointsMoistureValuesDate.push(row[1]);
	        		dataPointsMoistureValues.push(row[2]);
	        		dataPointsMoistureValuesError.push(Math.abs(row[2] - row[3]));

	        		j_global++;
        			lastRowMoisture = row[1];

        			isRowPushed = true;
	        	}
	        	else
	        	{
	        		isRowPushed = false;
	        	}
			});
		};

		var parseTempFile = function()
		{
			jQuery.get(temperatureSensorFile, function(data)
		    {
			    var lines = data.split("\n");
			    var len = lines.length;
    			var row = lines[len - 2].split(" ");

				if(row[1].localeCompare(lastRowTemp) != 0)
    			{
	        		dataPointsTempValuesDate.push(row[1]);
	        		dataPointsTempValues.push(row[2]);
	        		dataPointsTempValuesError.push(Math.abs(row[2] - row[3]));

	        		k_global++;
        			lastRowTemp = row[1];

        			isRowPushed = true;
	        	}
	        	else
	        	{
	        		isRowPushed = false;
	        	}
			});
		};

		var parseHumiFile = function()
		{
			jQuery.get(humiditySensorFile, function(data)
		    {
			    var lines = data.split("\n");
			    var len = lines.length;
    			var row = lines[len - 2].split(" ");

				if(row[1].localeCompare(lastRowTemp) != 0)
    			{
	        		dataPointsHumiValuesDate.push(row[1]);
	        		dataPointsHumiValues.push(row[2]);
	        		dataPointsHumiValuesError.push(Math.abs(row[2] - row[3]));

	        		k_global++;
        			lastRowTemp = row[1];

        			isRowPushed = true;
	        	}
	        	else
	        	{
	        		isRowPushed = false;
	        	}
			});
		};

		var updateLightSensorData = function(ddd)
		{
			dataPointsLight.push({ x: ddd, y: parseInt(dataPointsLightValues[i_global])});
        	dataPointsLightError.push({ x: ddd,  y: dataPointsLightValuesError[i_global]});

			if(dataPointsLight.length > MAX_CHART_LENGTH)
			{
				dataPointsLight.shift();
				dataPointsLightError.shift();
			}

			lightChart.render();
		};

		var updateMoistureSensorData = function(ddd)
		{
			dataPointsMoisture.push({ x: ddd, y: parseInt(dataPointsMoistureValues[j_global])});
        	dataPointsMoistureError.push({ x: ddd,  y: dataPointsMoistureValuesError[j_global]});

			if(dataPointsMoisture.length > MAX_CHART_LENGTH)
			{
				dataPointsMoisture.shift();
				dataPointsMoistureError.shift();
			}

			moistureSensorChart.render();
		};

		var updateTemperatureSensorData = function(ddd)
		{
			dataPointsTemp.push({ x: ddd, y: parseInt(dataPointsTempValues[k_global])});
        	dataPointsTempError.push({ x: ddd,  y: dataPointsTempValuesError[k_global]});

			if(dataPointsTemp.length > MAX_CHART_LENGTH)
			{
				dataPointsTemp.shift();
				dataPointsTempError.shift();
			}

			temperatureSensorChart.render();
		};

		var updateHumiditySensorData = function(ddd)
		{
			dataPointsHumi.push({ x: ddd, y: parseInt(dataPointsHumiValues[k_global])});
        	dataPointsHumiError.push({ x: ddd,  y: dataPointsHumiValuesError[k_global]});

			if(dataPointsHumi.length > MAX_CHART_LENGTH)
			{
				dataPointsHumi.shift();
				dataPointsHumiError.shift();
			}

			humiditySensorChart.render();
		};


		setInterval(function()
		{
			var now     = new Date(); 
	        var year    = now.getFullYear();
	        var month   = now.getMonth(); 
	        var day     = now.getDate();
	        var hour    = now.getHours();
	        var minute  = now.getMinutes();
	        var second  = now.getSeconds();

	        var ddd = new Date(year, month, day, hour, minute, second);

	        parseLightFile();
	        if(isRowPushed)
	        {
				updateLightSensorData(ddd);
	        }

	        parseMoistureFile();
			if(isRowPushed)
	        {
				updateMoistureSensorData(ddd);
			}

			parseTempFile();
			if(isRowPushed)
	        {
				updateTemperatureHumiditySensorData(ddd);
			}

			parseHumiFile();
			if(isRowPushed)
	        {
				updateHumiditySensorData(ddd);
			}

		}, 1000);
	}
	</script>
</head>
<body>
	<div class="chart" id="lightChartContainer"></div>
	<div class="chart" id="moistureSensorChartContainer"></div>
	<div class="chart" id="temperatureSensorChartContainer"></div>
	<div class="chart" id="humiditySensorChartContainer"></div>

	<p id="container"></p>
</body>
</html>